<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.mapper.AppointmentMapper">
<!-- 插入预约信息 -->
<insert id="saveAppointment" parameterType="com.example.model.domain.Appointment">
    insert into appointment
    <trim prefix="(" suffix=")" suffixOverrides=",">
        <if test="id != null">id,</if>
        <if test="studentId != null">studentId,</if>
        <if test="teacherId != null">teacherId,</if>
        <if test="subject != null">subject,</if>
        <if test="appointmentDate != null">appointmentDate,</if>
        <if test="appointmentTime != null">appointmentTime,</if>
        <if test="status != null">status</if>
    </trim>
    values
    <trim prefix="(" suffix=")" suffixOverrides=",">
        <if test="id != null">#{id},</if>
        <if test="studentId != null">#{studentId},</if>
        <if test="teacherId != null">#{teacherId},</if>
        <if test="subject != null">#{subject},</if>
        <if test="appointmentDate != null">#{appointmentDate},</if>
        <if test="appointmentTime != null">#{appointmentTime},</if>
        <if test="status != null">#{status}</if>
    </trim>
</insert>

        <!-- 查询所有预约信息 -->
<select id="getAllAppointments" resultType="com.example.model.domain.Appointment">
SELECT * FROM appointment
</select>
        <!-- 根据ID查询预约信息 -->
<select id="getAppointmentById" parameterType="long" resultType="com.example.model.domain.Appointment">
SELECT * FROM appointment WHERE id = #{id}
</select>

        <!-- 根据多个条件查询预约信息 -->
<select id="getAppointmentsByConditions" parameterType="map" resultType="com.example.model.domain.Appointment">
SELECT * FROM appointment
<where>
    <if test="id != null">id = #{id}</if>
    <if test="studentId != null">AND studentId = #{studentId}</if>
    <if test="teacherId != null">AND teacherId = #{teacherId}</if>
    <if test="subject != null">AND subject = #{subject}</if>
    <if test="appointmentDate != null">AND appointmentDate = #{appointmentDate}</if>
    <if test="appointmentTime != null">AND appointmentTime = #{appointmentTime}</if>
    <if test="status != null">AND status = #{status}</if>
</where>
</select>
        <!-- 更新预约信息 -->
<update id="updateAppointment" parameterType="com.example.model.domain.Appointment">
UPDATE appointment
<set>
    <if test="studentId != null">studentId = #{studentId},</if>
    <if test="teacherId != null">teacherId = #{teacherId},</if>
    <if test="subject != null">subject = #{subject},</if>
    <if test="appointmentDate != null">appointmentDate = #{appointmentDate},</if>
    <if test="appointmentTime != null">appointmentTime = #{appointmentTime},</if>
    <if test="status != null">status = #{status}</if>
</set>
WHERE id = #{id}
</update>

        <!-- 删除预约信息 -->
<delete id="deleteAppointmentById" parameterType="long">
DELETE FROM appointment WHERE id = #{id}
</delete>

<select id="getAppointmentsByTeacherId" parameterType="map" resultType="com.example.model.domain.Appointment">
SELECT a.id, a.studentId, s.name AS studentName, a.appointmentTime, a.status
FROM appointment a
JOIN student s ON a.studentId = s.id
<where>
    <if test="teacherId != null">a.teacherId = #{teacherId}</if>
    <if test="studentId != null">AND a.studentId = #{studentId}</if>
    <if test="status != null">AND a.status = #{status}</if>
</where>
ORDER BY a.appointmentTime
</select>

        <!--//查询特定日期的预约记录-->
<select id="getAppointmentsByTeacherIdAndDate" parameterType="map" resultType="com.example.model.domain.Appointment">
SELECT a.id, a.studentId, s.name AS studentName, a.appointmentTime, a.status
FROM appointment a
JOIN student s ON a.studentId = s.id
<where>
    <if test="teacherId != null">a.teacherId = #{teacherId}</if>
    <if test="date != null">AND DATE(a.appointmentTime) = #{date}</if>
    <if test="studentId != null">AND a.studentId = #{studentId}</if>
    <if test="status != null">AND a.status = #{status}</if>
</where>
ORDER BY a.appointmentTime
</select>

        <!--//取消预约-更新预约状态为取消-->
<update id="cancelAppointment" parameterType="map">
UPDATE appointment
SET status = #{newStatus}, updatedAt = CURRENT_TIMESTAMP
WHERE id = #{appointmentId}
<if test="teacherId != null">AND teacherId = #{teacherId}</if>
<if test="studentId != null">AND studentId = #{studentId}</if>
</update>

        <!--//更新预约信息-更新预约时间-->
<update id="updateAppointmentTime" parameterType="map">
UPDATE appointment
SET appointmentTime = #{newAppointmentTime}, updatedAt = CURRENT_TIMESTAMP
WHERE id = #{appointmentId}
<if test="teacherId != null">AND teacherId = #{teacherId}</if>
<if test="studentId != null">AND studentId = #{studentId}</if>
</update>

        <!--//更新预约状态-->
<update id="updateAppointmentStatus" parameterType="map">
UPDATE appointment
SET status = #{newStatus}, updatedAt = CURRENT_TIMESTAMP
WHERE id = #{appointmentId}
<if test="teacherId != null">AND teacherId = #{teacherId}</if>
<if test="studentId != null">AND studentId = #{studentId}</if>
</update>
</mapper>